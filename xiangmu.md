<!--
 * @Description:
 * @Author: lihewei
 * @Date: 2020-02-26 17:31:49
 * @LastEditors: lihewei
 * @LastEditTime: 2020-02-26 17:32:03
 -->

代码规范
1、各层分离，条理清晰，不在当前层涉及其他层的代码，尽量避免v层和m层的直接交互，调用方式为上层直接调用下层，下层通过发布订阅模式调用上层代码。

2、函数命名的主要前缀有：set、get、is、generate、save、delete、handle等等，可参考使用，场景需要时可用其他。

3、类中的属性方法规范：

    a、在类外定义的变量为私有属性

    b、在类中constructor中定义的变量为公有属性

    c、在类中声明的方法为公有方法

    d、在类外声明的方法为私有方法，约定以“_”开头

4、在各个类中用到的通用方法，可提取到工具类的业务层中

类关系图及分层




发送消息流程图




接收消息流程图




关于消息池的处理
一、存储
当每发送或收到一条消息时均将消息存储到消息池之中。

二、移除
只有当消息存储数据库成功后才将该消息从消息池中移除，否则一直在消息池中。

三、持久化
当关闭或刷新页面时将消息池中的数据持久化，保存到localStorage中。

四、历史消息渲染
点击会话或会话向上滚动加载新的会话时，从数据库拿出20条消息，并同时将消息池中在这20条消息的时间之内的消息取出，一起渲染。

五、写入数据库
每次页面初始化时或每隔一段时间尝试将消息池中的数据写入数据库中。

六、存储的消息类型
1、消息status为success：该消息发送成功，但是存储数据库时失败。
2、消息status为sending：该消息在sip发送时，此时用户刷新或关闭了页面，或者网络中断。对于这种消息，在每次初始化时均将status置为failed状态。
3、消息status为retry：该消息发送失败，同时存储数据库时也失败。
4、消息无status：该消息是收到的消息，存储数据库时失败。

重构的目的及解决的问题
1、项目架构的调整，便于后期对代码的维护和多人协同开发。
2、之前的发送逻辑操作了两次存储数据库的行为，现在改为一次存储，提升了性能，发送中的存储改为放到消息池中处理。
3、之前由于没有分层，收消息时处理渲染和存储数据库的逻辑比较混乱，导致了诸如左侧列表和聊天框渲染不一致等这类问题。现在将层次分清后，view层只负责渲染，其他底层的处理单独进行，诸如这些由于底层处理造成的影响不会让用户感知。
4、之前的逻辑，对于数据库存储失败的情况，会导致这条消息丢掉，现在由于在收发消息和存储数据库之间加了一层消息池的缓存，会避免消息丢失的情况，并且如果有错误消息或者解密失败的情况，可以在消息池中快速定位到这条错误消息。

时间安排
1、根据类关系及分层图，搭建整个项目的大致框架（0.5d）
2、SipManager类完善（0.5d）
3、HTTP封装及ServerApi封装用到的接口（0.25d）
4、RootManager类完善（0.5d）
5、MsgCachePool类完善、初始化及一段时间后存储数据库逻辑、关闭或刷新前存储到localStorage逻辑（1d）
6、MsgManager类完善，包括发送及接收逻辑（1.5d）（暂时不包括接收cmd消息的处理，这部分涵盖内容太多）
7、view层发送入口的梳理（0.25d）
8、接收及离线消息入口的梳理（0.5d）
9、Message类完善（1d）
10、TextMessage类完善（0.5d）
11、LongTextMessage、FileMessage、ImageMessage、MixMessage等文件类及流程的完善（2d）
12、Cmd类完善（1d）

1-8条的总时间为5天，9-12条总时间为4.5天。可以安排两个人分别处理这两部分，这样的话一周时间大致可以基本完善消息流程的重构。

之后重构的注意事项及剩余问题
目前的重构达到文本消息的发送、接收、转发走通并提测，文本的离线消息走通但未开放，消息池走通但未应用到实际。之后的重构包括：

1、文件消息、图片消息、cmd消息等其他所有消息的发送、接收、转发逻辑走通

2、发送消息发送中状态不需要存储数据库，接收消息先存数据库再渲染（这个已经完成）

3、彻底实现v层和m层的分离，发送消息后直接渲染，而不是再从数据库拿出数据渲染（Session类的重构）

4、离线消息逻辑重构

5、消息池的应用，主要为：

    a、离线消息执行完之后处理消息池的存储到数据库逻辑，即初始化和每七分钟处理一次

    b、每次消息池存储数据库后及页面刷新或关闭时，处理消息池存储localstorage逻辑，即初始化和每七分钟处理一次，刷新或关闭时处理一次

    c、每次的会话页面渲染，包括从数据库拿消息和从消息池拿消息两部分，两部分合起来为当前的会话内容

6、需引入会话缓存，即对会话内消息的所有操作不再是直接操作数据库，而是操作会话缓存

7、避免初始化的过多加载，做到按需加载。包括部分方法的发布，可在类实例化时发布，但需注意在用完后销毁，避免内存泄漏

8、indexedDB数据库已经根据现有逻辑做了修改，sqlite数据库也需要修改

9、SessionList类和Session类的重构为之后的两个最重要的部分，这两个类及消息类之间相互关联，可通过RootManager类这个中介者进行解耦

10、目前web端除了历史消息之外没有对人员信息、群组信息等进行本地持久化，以后可考虑引入，在这之前需要设计维护各个表及它们之间的关联







文件收发逻辑重构
文件处理主要包括两部分，第一部分为发送文件消息，第二部分为云盘、群空间上传直接上传文件。

发送文件消息包括：

普通文件（普通文件加密，上传接口rangeUpload，上传有进度条，支持重发。点击时下载）
大文件（大文件加密，上传接口rangeUpload，上传有进度条，支持重发。点击时下载）
图片（普通文件加密， 上传接口uploadFile。切换当前会话时下载。接口可替换成rangeUpload）
图文（普通文件加密， 上传接口uploadFile。切换当前会话时下载。接口可替换成rangeUpload）
长文本（普通文件加密，上传接口webUpload。点击时下载。接口可替换成rangeUpload）
云盘（此处不包括上传过程，只是发送云盘地址）
上传文件包括：

云盘（普通文件加密，分块加密上传，上传接口resumable_upload，不发送消息）
群空间（普通文件加密，分块加密上传，上传接口resumable_upload，此处会发送cmd消息）
发送流程与发送普通消息基本相同，中间部分有些差异：



新增类：

Sandbox：用来提供存和取沙盒文件的操作等
FileManager：提供方法upload和download，用来上层的调用
File：文件类，用来提供原始文件数据、md5加密数据、文件加密数据等等属性和方法
逻辑改动：

发送文件进度条的逻辑有改动，之前是将进度条直接存放在localstorage中，现在由于引入了msgPool，所以可以直接存在msgPool中，读取时也从msgPool中读取。
Message类的继承关系和接口需要重新调整
由于现在收文件消息时不处理文件的下载，故接收消息逻辑和普通消息处理一样。

云盘和群空间上传下载的逻辑改为，先实例化file对象，然后通过fileManager实现上传和下载

现在消息收发的大致逻辑都已完成，主逻辑走通已经没问题，一些细节的调整还有完善的地方可以和我沟通。pc端数据库需支持新的逻辑修改。沙盒包括文件管理系统设计有改动。文件处理逻辑有改动，后面做云盘时可以和我沟通。后面主要要解决的是会话置底回到首页的问题，牵扯session缓存，爬楼，会话渲染方式，消息池等等各个问题，是剩下的主要要解决的地方。有问题可以一起沟通交流。
